<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rozgrywki m≈Çodzie≈ºowe ‚Äì terminarze i rankingi</title>
<style>
  :root{
    --blue:#0d3b66;
    --gold:#c9a227;
    --bg:#f2f5f9;
    --row:#ffffff;
    --row-alt:#f7f8fa;
    --muted:#6b7280;
    --text:#111827;
    --border:#e8edf3;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
  header{background:var(--blue);color:#fff;padding:18px 16px;box-shadow:0 2px 8px rgba(0,0,0,.08);}
  header .wrap{max-width:1200px;margin:0 auto;}
  h1{margin:0;font-size:clamp(18px,2.3vw,24px);font-weight:700;}
  .container{max-width:1200px;margin:24px auto;padding:0 16px;}

  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
  .tab-btn{
    border:1px solid var(--border); background:#fff; color:#0d3b66;
    padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;
  }
  .tab-btn.active{background:linear-gradient(180deg,#114676 0%, #0d3b66 100%); color:#fff; border-color:#0d3b66}

  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr;} }

  .card{
    background:#fff; border:1px solid var(--border); border-radius:12px;
    box-shadow:0 6px 18px rgba(13,59,102,.08); overflow:hidden;
  }
  .card-header{
    background:linear-gradient(180deg,#114676 0%, #0d3b66 100%);
    color:#fff; padding:12px 14px; border-bottom:3px solid var(--gold);
    display:flex; align-items:center; justify-content:space-between;
  }
  .card-header h2{margin:0;font-size:16px}
  .card-body{padding:12px 14px}
  .subttl{margin:6px 0 10px; color:var(--muted); font-weight:600; font-size:14px}

  .table-wrap{overflow-x:auto}
  table{width:100%; border-collapse:collapse; min-width:700px}
  thead th{background:var(--blue); color:#fff; padding:9px 8px; text-align:center}
  tbody td{padding:9px 8px; text-align:center; border-bottom:1px solid var(--border); background:#fff}
  tbody tr:nth-child(even) td{background:var(--row-alt)}
  td.left{text-align:left}
  .note{color:var(--muted); font-size:12px; margin-top:6px}

  .muted{color:var(--muted)}

  /* Chipy/status + pod≈õwietlenie wierszy */
.chip{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
.chip-upcoming{background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe}
.chip-played{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}

tr.row-upcoming td{background:#f8fafc !important} /* delikatne t≈Ço */
tr.row-played   td{background:#f0fdf4 !important}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Rozgrywki m≈Çodzie≈ºowe ‚Äì terminarze i rankingi</h1>
  </div>
</header>

<main class="container">
  <!-- 4 zak≈Çadki -->
  <div class="tabs">
    <button class="tab-btn active" data-view="m_elim">M≈Çodzik ‚Äì Eliminacje</button>
    <button class="tab-btn" data-view="m_final">M≈Çodzik ‚Äì Fina≈Ç</button>
    <button class="tab-btn" data-view="f_elim">M≈Çodziczka ‚Äì Eliminacje</button>
    <button class="tab-btn" data-view="f_final">M≈Çodziczka ‚Äì Fina≈Ç</button>
  </div>

  <div id="view"></div>
</main>

<script>
/* <<< PODAJ SW√ìJ LINK DO APPS SCRIPT >>> */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzOZRmDTg3aSqEK4ut7NZRMzcmhsTjWCRtKKgMdZKkZ7JBV9rjO3_5IRKZgMVmX/exec?action=get";

/* ======== NARZƒòDZIA ======== */
function isUrl(v){
  try{ const u = new URL((v||'').trim()); return /^https?:$/.test(u.protocol); }catch(e){ return false; }
}
function parseDateAny(v){
  if (v instanceof Date && !isNaN(v)) return v;
  if (typeof v === 'string' && v.includes('T')) {
    const d = new Date(v); if (!isNaN(d)) return d;
  }
  if (typeof v === 'string' && v.includes('.')){
    const [d,m,y] = v.split('.').map(Number);
    const dd = new Date(y, (m||1)-1, d||1);
    if (!isNaN(dd)) return dd;
  }
  const d = new Date(v);
  return isNaN(d) ? null : d;
}
function fmtPL(v){
  const d = parseDateAny(v);
  return d ? d.toLocaleDateString('pl-PL') : (v ?? '');
}
function makeTableEl(headers, rows){
  const wrap = document.createElement('div');
  wrap.className = 'table-wrap';
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  headers.forEach(h=>{ const th = document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    r.forEach((cell, idx)=>{
      const td = document.createElement('td');
      if (cell && cell.__html){ td.innerHTML = cell.__html; }
      else { td.textContent = (cell ?? ''); }
      if (idx===0 && typeof cell === 'string') td.classList.add('left');
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); wrap.appendChild(table);
  return wrap;
}

/* ======== PARSOWANIE SET√ìW ======== */
// Sety zapis: "25:20 22:25 15:13"
function parseSets(setsStr){
  const txt = (setsStr||'').toString().trim();
  if (!txt) return {hSets:0,aSets:0,hPts:0,aPts:0};
  const parts = txt.split(/\s+/);
  let hSets=0,aSets=0,hPts=0,aPts=0;
  parts.forEach(p=>{
    const [h,a] = p.split(':').map(x=>parseInt(x,10));
    if (isNaN(h)||isNaN(a)) return;
    hPts += h; aPts += a;
    if (h>a) hSets++; else if (a>h) aSets++;
  });
  return {hSets,aSets,hPts,aPts};
}

/* ======== PUNKTACJA (2/1 dla wszystkich) ======== */
// zwyciƒôzca 2 pkt, przegrany 1 pkt ‚Äî tylko je≈õli mecz rozegrany (>= 1 set)
function matchPointsTwoOne(hSets, aSets){
  if ((hSets + aSets) === 0) return {home:0, away:0};
  if (hSets > aSets) return {home:2, away:1};
  if (aSets > hSets) return {home:1, away:2};
  return {home:0, away:0}; // remis nie wystƒôpuje
}

/* ======== LICZENIE TABELI ======== */
// rows: [date, home, away, wynik, sety, grupa, podgrupa, protok√≥≈Ç]
function computeTable(rows){
  const teams = {};
  const ensure = (name)=> (teams[name] ||= {
    team:name, matches:0, wins:0, losses:0,
    setsFor:0, setsAgainst:0, smallFor:0, smallAgainst:0,
    points:0
  });

  rows.forEach(r=>{
    const [date, home, away, score, setsStr] = r;
    if (!home || !away) return;

    const {hSets,aSets,hPts,aPts} = parseSets(setsStr);
    const {home:hp, away:ap} = matchPointsTwoOne(hSets,aSets);

    const H = ensure(home), A = ensure(away);

    if ((hSets+aSets) > 0){
      H.matches++; A.matches++;
      if (hSets > aSets){ H.wins++; A.losses++; } else if (aSets > hSets){ A.wins++; H.losses++; }
      H.setsFor += hSets; H.setsAgainst += aSets;
      A.setsFor += aSets; A.setsAgainst += hSets;
      H.smallFor += hPts; H.smallAgainst += aPts;
      A.smallFor += aPts; A.smallAgainst += hPts;
      H.points += hp; A.points += ap;
    }
  });

  const arr = Object.values(teams).map(t=>{
    const smallDiff = t.smallFor - t.smallAgainst;
    const setRatio = t.setsAgainst === 0 ? (t.setsFor>0?Infinity:0) : t.setsFor/t.setsAgainst;
    return {...t, smallDiff, setRatio};
  });

  // sort: punkty ‚Üí r√≥≈ºnica ma≈Çych ‚Üí sety+ ‚Üí stosunek set√≥w ‚Üí alfabet
  arr.sort((a,b)=>{
    if (b.points !== a.points) return b.points - a.points;
    if (b.smallDiff !== a.smallDiff) return b.smallDiff - a.smallDiff;
    if (b.setsFor !== a.setsFor) return b.setsFor - a.setsFor;
    if (b.setRatio !== a.setRatio) return b.setRatio - a.setRatio;
    return a.team.localeCompare(b.team,'pl');
  });

  return arr;
}

/* ======== KLASYFIKACJA FINA≈ÅOWA (15..1) ======== */
function classificationBonus(place){
  const p = 16 - place;
  return p >= 1 ? p : 1;
}

/* ======== BLOKI WIDOKU ======== */
function renderTerminarzBlock(title, rows){
  const card = document.createElement('div'); card.className='card';
  const head = document.createElement('div'); head.className='card-header';
  head.innerHTML = `<h2>${title}</h2>`;
  const body = document.createElement('div'); body.className='card-body';

  // DORZUCAMY kolumnƒô "Status" przed "Protok√≥≈Ç"
  const headers = ['Data','Gospodarz','Go≈õƒá','Wynik','Sety','Grupa','Podgrupa','Status','Protok√≥≈Ç'];

  const mapped = rows.slice().sort((a,b)=>{
    const dA = parseDateAny(a[0])?.getTime()||0;
    const dB = parseDateAny(b[0])?.getTime()||0;
    return dA - dB;
  }).map(r=>{
    const proto = isUrl(r[7]) ? {__html:`<a href="${r[7]}" target="_blank" rel="noopener">üìÑ protok√≥≈Ç</a>`} : '‚Äî';
    const st = statusBadge(r);
    const badge = st.cls ? {__html:`<span class="chip ${st.cls}">${st.text}</span>`} : st.text;

    // do≈ÇƒÖcz ‚Äûznacznik‚Äù klasy wiersza na pierwszej kom√≥rce (u≈ºyjemy go przy renderze)
    const dateCell = {__html:`<span data-rowcls="${st.rowCls||''}">${fmtPL(r[0])}</span>`};

    return [dateCell, r[1], r[2], r[3]||'', r[4]||'', r[5]||'', r[6]||'', badge, proto];
  });

  // renderer z obs≈ÇugƒÖ klasy wiersza (row-upcoming/row-played)
  const wrap = document.createElement('div');
  wrap.className = 'table-wrap';
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  headers.forEach(h=>{ const th = document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  mapped.forEach(row=>{
    const tr = document.createElement('tr');
    row.forEach((cell, idx)=>{
      const td = document.createElement('td');
      if (cell && cell.__html){ td.innerHTML = cell.__html; }
      else { td.textContent = (cell ?? ''); }
      if (idx===0){
        td.classList.add('left');
        // odczytaj klasƒô wiersza z data-rowcls osadzonego w dacie
        const span = td.querySelector('span[data-rowcls]');
        const rowCls = span ? span.getAttribute('data-rowcls') : '';
        if (rowCls) tr.classList.add(rowCls);
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.appendChild(table);

  body.appendChild(wrap);
  card.appendChild(head); card.appendChild(body);
  return card;
}


function renderRankingBlock(title, tableRows, withFinalBonus=false){
  const card = document.createElement('div'); card.className='card';
  const head = document.createElement('div'); head.className='card-header';
  head.innerHTML = `<h2>${title}</h2>`;
  const body = document.createElement('div'); body.className='card-body';

  let headers, rows;
  if (!withFinalBonus){
    headers = ['Miejsce','Dru≈ºyna','M','W','P','Sety (+/‚àí)','Ma≈Çe (+/‚àí)','Punkty'];
    rows = tableRows.map((t,idx)=>[
      idx+1,
      t.team,
      t.matches,
      t.wins,
      t.losses,
      `${t.setsFor}:${t.setsAgainst}`,
      `${t.smallFor}:${t.smallAgainst}  (${t.smallFor - t.smallAgainst >=0?'+':''}${t.smallFor - t.smallAgainst})`,
      t.points
    ]);
  } else {
    headers = ['Miejsce','Dru≈ºyna','M','W','P','Sety (+/‚àí)','Ma≈Çe (+/‚àí)','Punkty meczowe','Klasyfikacyjne','Razem'];
    rows = tableRows.map((t,idx)=>{
      const place = idx+1;
      const bonus = classificationBonus(place);
      const total = t.points + bonus;
      return [
        place,
        t.team,
        t.matches,
        t.wins,
        t.losses,
        `${t.setsFor}:${t.setsAgainst}`,
        `${t.smallFor}:${t.smallAgainst}  (${t.smallFor - t.smallAgainst >=0?'+':''}${t.smallFor - t.smallAgainst})`,
        t.points,
        bonus,
        total
      ];
    });
  }

  body.appendChild(makeTableEl(headers, rows));
  card.appendChild(head); card.appendChild(body);
  return card;
}

/* ======== GRUPOWANIE: Grupa I/II/III‚Ä¶ ‚Üí Podgrupa A/B ======== */
function normGroupLabel(g){
  if (!g) return '';
  const s = g.toString().trim().toUpperCase();
  // akceptujemy "I", "II", "III"‚Ä¶ lub "1","2","3" (zamieniamy na rzymskie I/II/III‚Ä¶ w wy≈õwietlaniu)
  if (/^\d+$/.test(s)){
    const n = parseInt(s,10);
    const romans = ['','I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV','XV'];
    return romans[n] || s;
  }
  return s; // ju≈º I/II‚Ä¶
}
function groupByGroupAndSub(rows){
  // zwraca: { 'I': { 'A': [...], 'B': [...] }, 'II': {...}, ... }
  const out = {};
  rows.forEach(r=>{
    const g = normGroupLabel(r[5]||''); // kolumna Grupa
    const sub = (r[6]||'').toString().trim().toUpperCase(); // kolumna Podgrupa
    if (!g || !sub) return;
    out[g] ||= {A:[], B:[]};
    if (sub === 'A' || sub === 'B'){
      out[g][sub].push(r);
    }
  });
  return out;
}
  function hasScoreOrSets(score, sets){
  const sOk = typeof score === 'string' && score.includes(':');
  const setsOk = typeof sets === 'string' && /\d+:\d+/.test(sets);
  return sOk || setsOk;
}

function isUpcomingDate(rawDate){
  const d = parseDateAny(rawDate);
  if (!d) return false;
  const today = new Date(); today.setHours(0,0,0,0);
  return d >= today;
}

function statusBadge(row){
  const [rawDate, , , score, sets] = row;
  const played = hasScoreOrSets(score, sets);
  if (played) return { text:'‚úÖ Rozegrany', cls:'chip-played', rowCls:'row-played' };
  if (isUpcomingDate(rawDate)) return { text:'‚è≥ NadchodzƒÖcy', cls:'chip-upcoming', rowCls:'row-upcoming' };
  // po terminie, ale brak wyniku ‚Äì traktujemy neutralnie
  return { text:'‚Äî', cls:'', rowCls:'' };
}

/* ======== WIDOKI ======== */
function renderElimView(allRows, label){ // label: "M≈Çodzik" / "M≈Çodziczka"
  // Grupa I/II/III‚Ä¶ ‚Üí Podgrupa A/B
  const groups = groupByGroupAndSub(allRows);
  const view = document.createElement('div');

  // sortuj grupy po rzymskich (I, II, III‚Ä¶)
  const groupKeys = Object.keys(groups).sort((a,b)=>{
    const order = ['','I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV','XV'];
    return (order.indexOf(a) - order.indexOf(b));
  });

  if (groupKeys.length === 0){
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='card-header';
    head.innerHTML = `<h2>${label} ‚Äì Eliminacje</h2>`;
    const body = document.createElement('div'); body.className='card-body';
    body.innerHTML = `<p class="muted">Brak danych w arkuszu.</p>`;
    card.appendChild(head); card.appendChild(body);
    view.appendChild(card);
    return view;
  }

  groupKeys.forEach(g=>{
    const pack = groups[g];
    // Ka≈ºdƒÖ podgrupƒô (A i B) pokazujemy jako: Terminarz + Ranking (2/1, do 2 set√≥w)
    ['A','B'].forEach(sub=>{
      const rows = pack[sub] || [];
      if (rows.length === 0) return;
      const grid = document.createElement('div'); grid.className='grid';
      const term = renderTerminarzBlock(`${label} ‚Äì Eliminacje ‚Äì Grupa ${g} ‚Äì Podgrupa ${sub}`, rows);
      const table = computeTable(rows); // 2/1 dla wszystkich kategorii
      const rank = renderRankingBlock(`Ranking ‚Äì ${label} ‚Äì Grupa ${g} ‚Äì Podgrupa ${sub}`, table, false);
      grid.appendChild(term); grid.appendChild(rank);
      view.appendChild(grid);
    });
  });

  return view;
}

function renderFinalView(allRows, label){
  const view = document.createElement('div');
  const grid = document.createElement('div'); grid.className='grid';

  const term = renderTerminarzBlock(`${label} ‚Äì Fina≈Ç`, allRows);
  const table = computeTable(allRows); // 2/1 dla wszystkich
  const rank = renderRankingBlock(`Ranking ‚Äì ${label} ‚Äì Fina≈Ç (z klasyfikacjƒÖ 15..1)`, table, true);

  grid.appendChild(term); grid.appendChild(rank);
  view.appendChild(grid);
  return view;
}

/* ======== APLIKACJA ======== */
let DATA = null;

function setActive(btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function renderView(kind){
  const mount = document.getElementById('view');
  mount.innerHTML = '';
  if (!DATA) return;

  if (kind === 'm_elim') {
    mount.appendChild(renderElimView(DATA.m_elim||[], 'M≈Çodzik'));
  } else if (kind === 'm_final') {
    mount.appendChild(renderFinalView(DATA.m_final||[], 'M≈Çodzik'));
  } else if (kind === 'f_elim') {
    mount.appendChild(renderElimView(DATA.f_elim||[], 'M≈Çodziczka'));
  } else if (kind === 'f_final') {
    mount.appendChild(renderFinalView(DATA.f_final||[], 'M≈Çodziczka'));
  }
}

async function boot(){
  const res = await fetch(WEB_APP_URL, {cache:'no-store'});
  DATA = await res.json();

  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      setActive(btn);
      renderView(btn.dataset.view);
    });
  });

  renderView('m_elim'); // start
}
boot();

</script>
</body>
</html>
