<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rozgrywki młodzieżowe – terminarze i rankingi</title>
<style>
  :root{
    --blue:#0d3b66; --gold:#c9a227; --bg:#f2f5f9;
    --row:#fff; --row-alt:#f7f8fa; --muted:#6b7280;
    --text:#111827; --border:#e8edf3;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
  header{background:var(--blue);color:#fff;padding:18px 16px;box-shadow:0 2px 8px rgba(0,0,0,.08);}
  header .wrap{max-width:1200px;margin:0 auto;}
  h1{margin:0;font-size:clamp(18px,2.3vw,24px);font-weight:700;}
  .container{max-width:1200px;margin:24px auto;padding:0 16px;}
  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
  .tab-btn{border:1px solid var(--border); background:#fff; color:#0d3b66; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;}
  .tab-btn.active{background:linear-gradient(180deg,#114676 0%, #0d3b66 100%); color:#fff; border-color:#0d3b66}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr;} }
  .card{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 6px 18px rgba(13,59,102,.08); overflow:hidden;}
  .card-header{background:linear-gradient(180deg,#114676 0%, #0d3b66 100%); color:#fff; padding:12px 14px; border-bottom:3px solid var(--gold); display:flex; align-items:center; justify-content:space-between;}
  .card-header h2{margin:0;font-size:16px}
  .card-body{padding:12px 14px}
  .table-wrap{overflow-x:auto}
  table{width:100%; border-collapse:collapse; min-width:700px}
  thead th{background:var(--blue); color:#fff; padding:9px 8px; text-align:center}
  tbody td{padding:9px 8px; text-align:center; border-bottom:1px solid var(--border); background:#fff}
  tbody tr:nth-child(even) td{background:var(--row-alt)}
  td.left{text-align:left}
  .muted{color:var(--muted)}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .chip-upcoming{background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe}
  .chip-played{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
  tr.row-upcoming td{background:#f8fafc !important}
  tr.row-played td{background:#f0fdf4 !important}

  /* Ekran ładowania */
#loading-screen {
  position: fixed;
  inset: 0;
  background: #fff;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-logo {
  width: 120px;
  animation: pulse 1.2s infinite;
}

@keyframes pulse {
  0%   { opacity: 1; }
  50%  { opacity: 0.4; }
  100% { opacity: 1; }
}

  
</style>
</head>
<body>
<header><div class="wrap"><h1>Rozgrywki młodzieżowe – terminarze i rankingi</h1></div></header>

<main class="container">
  <div class="tabs">
    <button class="tab-btn active" data-view="m_roz1">Młodzik – Rozstaw I</button>
    <button class="tab-btn" data-view="m_roz2">Młodzik – Rozstaw II</button>
    <button class="tab-btn" data-view="m_liga">Młodzik – Liga</button>
    <button class="tab-btn" data-view="m_final">Młodzik – Finał</button>
    <button class="tab-btn" data-view="f_roz1">Młodziczka – Rozstaw I</button>
    <button class="tab-btn" data-view="f_roz2">Młodziczka – Rozstaw II</button>
    <button class="tab-btn" data-view="f_liga">Młodziczka – Liga</button>
    <button class="tab-btn" data-view="f_final">Młodziczka – Finał</button>
    <button class="tab-btn" data-view="m_overall">Młodzik – Ranking ogólny</button>
    <button class="tab-btn" data-view="f_overall">Młodziczka – Ranking ogólny</button>

  </div>
  <!-- Ekran ładowania -->
  <div id="loading-screen">
    <img src="logo-pzps.png" alt="PZPS" class="loading-logo">
    <p>Ładowanie danych...</p>
  </div>
  <div id="view"></div>
</main>

<script>
// ========= KONFIG =========
// jeśli masz CORS ok na Apps Script, możesz użyć bezpośrednio WEB_APP_URL_BASE + "?action=get"
const WEB_APP_URL_BASE = "https://script.google.com/macros/s/AKfycbwxcm10QSkzvs5uUX3RyRXL3xA5Ci01_bNyuLRjFxYYRIqUo3qE23lt9qwPks75IaXu/exec";
const WEB_APP_URL = "https://corsproxy.io/?" + encodeURIComponent(WEB_APP_URL_BASE + "?action=get&cb=" + Date.now());

// ========= Utils =========
function isUrl(v){ try{ const u = new URL((v||'').trim()); return /^https?:$/.test(u.protocol); }catch(e){ return false; } }
function parseDateAny(v){
  if (v instanceof Date && !isNaN(v)) return v;
  if (typeof v === 'string' && v.includes('T')) { const d = new Date(v); if (!isNaN(d)) return d; }
  if (typeof v === 'string' && v.includes('.')){ const [d,m,y] = v.split('.').map(Number); const dd = new Date(y,(m||1)-1,d||1); if (!isNaN(dd)) return dd; }
  const d = new Date(v); return isNaN(d) ? null : d;
}
function fmtPL(v){ const d = parseDateAny(v); return d ? d.toLocaleDateString('pl-PL') : (v ?? ''); }

function makeTableEl(headers, rows){
  const wrap = document.createElement('div'); wrap.className='table-wrap';
  const table = document.createElement('table');
  const thead = document.createElement('thead'); const trh = document.createElement('tr');
  headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    r.forEach((cell, idx)=>{
      const td = document.createElement('td');
      if (cell && cell.__html){ td.innerHTML = cell.__html; } else { td.textContent = (cell ?? ''); }
      if (idx===0 && typeof cell === 'string') td.classList.add('left');
      if (idx===0 && cell && cell.__html){
        const span=td.querySelector('span[data-rowcls]'); const rowCls=span?span.getAttribute('data-rowcls'):'';
        if (rowCls) tr.classList.add(rowCls);
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); wrap.appendChild(table);
  return wrap;
}

// ========= Sety + punktacja 2/1 =========
function parseSets(setsStr){
  const txt=(setsStr||'').toString().trim(); if (!txt) return {hSets:0,aSets:0,hPts:0,aPts:0};
  const parts=txt.split(/\s+/); let hSets=0,aSets=0,hPts=0,aPts=0;
  parts.forEach(p=>{
    const [h,a]=p.split(':').map(n=>parseInt(n,10));
    if (isNaN(h)||isNaN(a)) return;
    hPts+=h; aPts+=a;
    if (h>a) hSets++; else if (a>h) aSets++;
  });
  return {hSets,aSets,hPts,aPts};
}
function matchPointsTwoOne(hSets,aSets){
  if ((hSets+aSets)===0) return {home:0,away:0};
  if (hSets>aSets) return {home:2,away:1};
  if (aSets>hSets) return {home:1,away:2};
  return {home:0,away:0};
}
function computeTable(rows){
  const teams={};
  const ensure=n=>teams[n]||(teams[n]={team:n,matches:0,wins:0,losses:0,setsFor:0,setsAgainst:0,smallFor:0,smallAgainst:0,points:0});
  rows.forEach(r=>{
    const [ , home, away, , setsStr] = r;
    if (!home || !away) return;
    const {hSets,aSets,hPts,aPts}=parseSets(setsStr);
    const {home:hp,away:ap}=matchPointsTwoOne(hSets,aSets);
    const H=ensure(home), A=ensure(away);
    if ((hSets+aSets)>0){
      H.matches++; A.matches++;
      if (hSets>aSets){ H.wins++; A.losses++; } else if (aSets>hSets){ A.wins++; H.losses++; }
      H.setsFor+=hSets; H.setsAgainst+=aSets; A.setsFor+=aSets; A.setsAgainst+=hSets;
      H.smallFor+=hPts; H.smallAgainst+=aPts; A.smallFor+=aPts; A.smallAgainst+=hPts;
      H.points+=hp; A.points+=ap;
    }
  });
  const arr=Object.values(teams).map(t=>({ ...t, smallDiff:t.smallFor-t.smallAgainst, setRatio: t.setsAgainst===0 ? (t.setsFor>0?Infinity:0) : t.setsFor/t.setsAgainst }));
  arr.sort((a,b)=>{
    if (b.points!==a.points) return b.points-a.points;
    if (b.smallDiff!==a.smallDiff) return b.smallDiff-a.smallDiff;
    if (b.setsFor!==a.setsFor) return b.setsFor-a.setsFor;
    if (b.setRatio!==a.setRatio) return b.setRatio-a.setRatio;
    return a.team.localeCompare(b.team,'pl');
  });
  return arr;
}

// ========= Status/kolory wierszy =========
function hasScoreOrSets(score, sets){ const sOk = typeof score==='string' && score.includes(':'); const setsOk = typeof sets==='string' && /\d+:\d+/.test(sets); return sOk || setsOk; }
function isUpcomingDate(rawDate){ const d=parseDateAny(rawDate); if(!d) return false; const t=new Date(); t.setHours(0,0,0,0); return d>=t; }
function statusBadge(row){
  const [rawDate, , , score, sets] = row; const played=hasScoreOrSets(score,sets);
  if (played) return {text:'✅ Rozegrany', cls:'chip-played', rowCls:'row-played'};
  if (isUpcomingDate(rawDate)) return {text:'⏳ Nadchodzący', cls:'chip-upcoming', rowCls:'row-upcoming'};
  return {text:'—', cls:'', rowCls:''};
}

// ========= Grupowania =========
function normRoman(g){
  if (!g) return '';
  const s=g.toString().trim().toUpperCase();
  if (/^\d+$/.test(s)){
    const n=parseInt(s,10);
    const romans=['','I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV','XV','XVI','XVII','XVIII','XIX','XX'];
    return romans[n]||s;
  }
  return s;
}
function groupByRozstaw(rows){
  // -> {'I':{A:[...],B:[...]}, ...}  (kol. 5=Grupa, 6=Podgrupa)
  const out={};
  rows.forEach(r=>{
    const g=normRoman(r[5]||''); const sub=(r[6]||'').toString().trim().toUpperCase();
    if(!g||!sub) return;
    out[g] ||= {A:[],B:[]};
    if (sub==='A'||sub==='B') out[g][sub].push(r);
  });
  return out;
}
function groupByLiga(rows, ligaColIndex){
  const out={};
  rows.forEach(r=>{
    const l=normRoman(r[ligaColIndex]||''); if(!l) return;
    (out[l] ||= []).push(r);
  });
  return out;
}

// ========= Renderery terminarzy =========
function renderTermRozstaw(title, rows){
  const headers = ['Data','Gospodarz','Gość','Wynik','Sety','Grupa','Podgrupa','Status','Protokół'];
  const mapped = rows.slice()
    .sort((a,b)=> (parseDateAny(a[0])?.getTime()||0) - (parseDateAny(b[0])?.getTime()||0))
    .map(r=>{
      const st=statusBadge(r);
      const dateCell={__html:`<span data-rowcls="${st.rowCls||''}">${fmtPL(r[0])}</span>`};
      const proto = isUrl(r[7]) ? {__html:`<a href="${r[7]}" target="_blank" rel="noopener">📄 protokół</a>`} : '—';
      const badge = st.cls ? {__html:`<span class="chip ${st.cls}">${st.text}</span>`} : st.text;
      return [dateCell, r[1], r[2], r[3]||'', r[4]||'', r[5]||'', r[6]||'', badge, proto];
    });
  return makeCard(title, makeTableEl(headers, mapped));
}
function renderTermLigaM(title, rows){
  const headers = ['Data','Gospodarz','Gość','Wynik','Sety','Liga','Kolejka','Status','Protokół'];
  const mapped = rows.slice()
    .sort((a,b)=> (parseDateAny(a[0])?.getTime()||0) - (parseDateAny(b[0])?.getTime()||0))
    .map(r=>{
      const st=statusBadge(r);
      const dateCell={__html:`<span data-rowcls="${st.rowCls||''}">${fmtPL(r[0])}</span>`};
      const proto = isUrl(r[7]) ? {__html:`<a href="${r[7]}" target="_blank" rel="noopener">📄 protokół</a>`} : '—';
      const badge = st.cls ? {__html:`<span class="chip ${st.cls}">${st.text}</span>`} : st.text;
      return [dateCell, r[1], r[2], r[3]||'', r[4]||'', r[5]||'', r[6]||'', badge, proto];
    });
  return makeCard(title, makeTableEl(headers, mapped));
}
function renderTermLigaF(title, rows){
  const headers = ['Data','Gospodarz','Gość','Wynik','Sety','Liga','Status','Protokół'];
  const mapped = rows.slice()
    .sort((a,b)=> (parseDateAny(a[0])?.getTime()||0) - (parseDateAny(b[0])?.getTime()||0))
    .map(r=>{
      const st=statusBadge(r);
      const dateCell={__html:`<span data-rowcls="${st.rowCls||''}">${fmtPL(r[0])}</span>`};
      const proto = isUrl(r[6]) ? {__html:`<a href="${r[6]}" target="_blank" rel="noopener">📄 protokół</a>`} : '—';
      const badge = st.cls ? {__html:`<span class="chip ${st.cls}">${st.text}</span>`} : st.text;
      return [dateCell, r[1], r[2], r[3]||'', r[4]||'', r[5]||'', badge, proto];
    });
  return makeCard(title, makeTableEl(headers, mapped));
}
function renderTermFinal(title, rows){
  const headers = ['Data','Gospodarz','Gość','Wynik','Sety','Status','Protokół'];
  const mapped = rows.slice()
    .sort((a,b)=> (parseDateAny(a[0])?.getTime()||0) - (parseDateAny(b[0])?.getTime()||0))
    .map(r=>{
      const st=statusBadge(r);
      const dateCell={__html:`<span data-rowcls="${st.rowCls||''}">${fmtPL(r[0])}</span>`};
      const proto = isUrl(r[5]) ? {__html:`<a href="${r[5]}" target="_blank" rel="noopener">📄 protokół</a>`} : '—';
      const badge = st.cls ? {__html:`<span class="chip ${st.cls}">${st.text}</span>`} : st.text;
      return [dateCell, r[1], r[2], r[3]||'', r[4]||'', badge, proto];
    });
  return makeCard(title, makeTableEl(headers, mapped));
}

// ========= Bonusy finałowe =========
const BONUS_BY_KIND = { mlodzik:16, mlodziczka:42 };
function classificationBonus(place, maxBonus){ const v = maxBonus - (place - 1); return v>=1 ? v : 1; }

// ========= Ranking (z/bez bonusów) =========
function renderRanking(title, tableRows, opts = {}){
  const isFinal  = !!opts.final;
  const maxBonus = Number(opts.maxBonus ?? BONUS_BY_KIND[opts.kind] ?? 0);

  let headers, rows;
  if (!isFinal){
    headers = ['Miejsce','Drużyna','M','W','P','Sety (+/−)','Małe (+/−)','Punkty'];
    rows = tableRows.map((t,idx)=>[
      idx+1, t.team, t.matches, t.wins, t.losses,
      `${t.setsFor}:${t.setsAgainst}`,
      `${t.smallFor}:${t.smallAgainst} (${t.smallFor - t.smallAgainst >=0?'+':''}${t.smallFor - t.smallAgainst})`,
      t.points
    ]);
  } else {
    headers = ['Miejsce','Drużyna','M','W','P','Sety (+/−)','Małe (+/−)','Punkty meczowe','Klasyfikacyjne','Razem'];
    rows = tableRows.map((t,idx)=>{
      const place = idx+1;
      const bonus = classificationBonus(place, maxBonus);
      const total = t.points + bonus;
      return [
        place, t.team, t.matches, t.wins, t.losses,
        `${t.setsFor}:${t.setsAgainst}`,
        `${t.smallFor}:${t.smallAgainst} (${t.smallFor - t.smallAgainst >=0?'+':''}${t.smallFor - t.smallAgainst})`,
        t.points, bonus, total
      ];
    });
  }
  return makeCard(title, makeTableEl(headers, rows));
}

// ========= Widoki logiczne =========
function viewRozstaw(label, rows){
  const groups = groupByRozstaw(rows);
  const root=document.createElement('div');
  const order=['','I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV'];
  Object.keys(groups).sort((a,b)=>order.indexOf(a)-order.indexOf(b)).forEach(g=>{
    ['A','B'].forEach(sub=>{
      const pack = groups[g][sub];
      if (!pack || pack.length===0) return;
      const grid=document.createElement('div'); grid.className='grid';
      const term = renderTermRozstaw(`${label} – Rozstaw ${g} – Podgrupa ${sub}`, pack);
      const rank = renderRanking(`Ranking – ${label} – Rozstaw ${g} – Podgrupa ${sub}`, computeTable(pack));
      grid.appendChild(term); grid.appendChild(rank); root.appendChild(grid);
    });
  });
  if (!root.children.length){ root.appendChild(makeCard(`${label} – Rozstaw`, document.createTextNode('Brak danych'))); }
  return root;
}
function viewLigaM(rows){
  const byLiga = groupByLiga(rows, 5); // kolumna „Liga”
  const root=document.createElement('div');
  const order=['','I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV'];
  Object.keys(byLiga).sort((a,b)=>order.indexOf(a)-order.indexOf(b)).forEach(l=>{
    const pack = byLiga[l];
    const grid=document.createElement('div'); grid.className='grid';
    const term = renderTermLigaM(`Młodzik – Liga ${l}`, pack);
    const rank = renderRanking(`Ranking – Młodzik – Liga ${l}`, computeTable(pack));
    grid.appendChild(term); grid.appendChild(rank); root.appendChild(grid);
  });
  if (!root.children.length){ root.appendChild(makeCard(`Młodzik – Liga`, document.createTextNode('Brak danych'))); }
  return root;
}
function viewLigaF(rows){
  const byLiga = groupByLiga(rows, 5); // kolumna „Liga”
  const root=document.createElement('div');
  const order=['','I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV'];
  Object.keys(byLiga).sort((a,b)=>order.indexOf(a)-order.indexOf(b)).forEach(l=>{
    const pack = byLiga[l];
    const grid=document.createElement('div'); grid.className='grid';
    const term = renderTermLigaF(`Młodziczka – Liga ${l}`, pack);
    const rank = renderRanking(`Ranking – Młodziczka – Liga ${l}`, computeTable(pack));
    grid.appendChild(term); grid.appendChild(rank); root.appendChild(grid);
  });
  if (!root.children.length){ root.appendChild(makeCard(`Młodziczka – Liga`, document.createTextNode('Brak danych'))); }
  return root;
}
  // ===== Ranking ogólny z 5 kolejek (sumuje wszystkie mecze z arkusza LIGA) =====
function viewOverall(label, rows){
  const root = document.createElement('div');

  // computeTable liczy systemem 2/1 (mamy to już w kodzie)
  const table = computeTable(rows);

  // gotowy renderer tabeli (bez bonusów, zwykłe M/W/P itd.)
  const rank = renderRanking(`Ranking ogólny – ${label}`, table);

  root.appendChild(rank);
  return root;
}
function renderFinalView(allRows, label){
  const view = document.createElement('div');
  const grid = document.createElement('div'); grid.className='grid';
  const term = renderTermFinal(`${label} – Finał`, allRows);
  const table = computeTable(allRows);
  const kind = (label==='Młodzik') ? 'mlodzik' : (label==='Młodziczka' ? 'mlodziczka' : undefined);
  const rank = kind ? renderRanking(`Ranking – ${label} – Finał`, table, { final:true, kind }) : renderRanking(`Ranking – ${label} – Finał`, table);
  grid.appendChild(term); grid.appendChild(rank); view.appendChild(grid);
  return view;
}

// ========= Router zakładek =========
let DATA=null;
function setActive(btn){ document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
function renderView(kind){
  const mount=document.getElementById('view'); mount.innerHTML='';
  if (!DATA) return;
  if (kind==='m_roz1')      mount.appendChild( viewRozstaw('Młodzik',     DATA.m_rozstaw_i  ||[]) );
  else if (kind==='m_roz2') mount.appendChild( viewRozstaw('Młodzik',     DATA.m_rozstaw_ii ||[]) );
  else if (kind==='m_liga') mount.appendChild( viewLigaM(                 DATA.m_liga       ||[]) );
  else if (kind==='m_final')mount.appendChild( renderFinalView(           DATA.m_final      ||[], 'Młodzik') );
  else if (kind==='f_roz1') mount.appendChild( viewRozstaw('Młodziczka',  DATA.f_rozstaw_i  ||[]) );
  else if (kind==='f_roz2') mount.appendChild( viewRozstaw('Młodziczka',  DATA.f_rozstaw_ii ||[]) );
  else if (kind==='f_liga') mount.appendChild( viewLigaF(                 DATA.f_liga       ||[]) );
  else if (kind==='f_final')mount.appendChild( renderFinalView(           DATA.f_final      ||[], 'Młodziczka') );
  else if (kind==='m_overall') mount.appendChild( viewOverall('Młodzik', DATA.m_liga||[]) );
  else if (kind==='f_overall') mount.appendChild( viewOverall('Młodziczka', DATA.f_liga||[]) );
}

// ========= Start =========
async function boot(){
  try{
    const res = await fetch(WEB_APP_URL, {cache:'no-store'});
    if (!res.ok) throw new Error('HTTP '+res.status);
    DATA = await res.json();
  }catch(err){
    const mount=document.getElementById('view');
    const card = makeCard('Błąd', document.createTextNode('Nie udało się pobrać danych z Apps Script.\nSzczegóły: '+err));
    mount.appendChild(card);
    return;
  }
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ setActive(btn); renderView(btn.dataset.view); });
  });
  renderView('m_roz1'); // domyślnie

  // 🔽 schowaj ekran ładowania
  document.getElementById('loading-screen').style.display = 'none';
}
boot();

// ========= makeCard helper =========
function makeCard(title, innerEl){
  const card=document.createElement('div'); card.className='card';
  const head=document.createElement('div'); head.className='card-header'; head.innerHTML=`<h2>${title}</h2>`;
  const body=document.createElement('div'); body.className='card-body'; body.appendChild(innerEl);
  card.appendChild(head); card.appendChild(body); return card;
}
</script>
</body>
</html>
