<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rozgrywki m≈Çodzie≈ºowe ‚Äì terminarze i rankingi</title>
<style>
  :root{
    --blue:#0d3b66; --gold:#c9a227; --bg:#f2f5f9;
    --row:#fff; --row-alt:#f7f8fa; --muted:#6b7280;
    --text:#111827; --border:#e8edf3;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
  header{background:var(--blue);color:#fff;padding:18px 16px;box-shadow:0 2px 8px rgba(0,0,0,.08);}
  header .wrap{max-width:1200px;margin:0 auto;}
  h1{margin:0;font-size:clamp(18px,2.3vw,24px);font-weight:700;}
  .container{max-width:1200px;margin:24px auto;padding:0 16px;}
  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
  .tab-btn{border:1px solid var(--border); background:#fff; color:#0d3b66; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;}
  .tab-btn.active{background:linear-gradient(180deg,#114676 0%, #0d3b66 100%); color:#fff; border-color:#0d3b66}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr;} }
  .card{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 6px 18px rgba(13,59,102,.08); overflow:hidden;}
  .card-header{background:linear-gradient(180deg,#114676 0%, #0d3b66 100%); color:#fff; padding:12px 14px; border-bottom:3px solid var(--gold); display:flex; align-items:center; justify-content:space-between;}
  .card-header h2{margin:0;font-size:16px}
  .card-body{padding:12px 14px}
  .table-wrap{overflow-x:auto}
  table{width:100%; border-collapse:collapse; min-width:700px}
  thead th{background:var(--blue); color:#fff; padding:9px 8px; text-align:center}
  tbody td{padding:9px 8px; text-align:center; border-bottom:1px solid var(--border); background:#fff}
  tbody tr:nth-child(even) td{background:var(--row-alt)}
  td.left{text-align:left}
  .muted{color:var(--muted)}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .chip-upcoming{background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe}
  .chip-played{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
  tr.row-upcoming td{background:#f8fafc !important}
  tr.row-played td{background:#f0fdf4 !important}

  /* Ekran ≈Çadowania */
#loading-screen {
  position: fixed;
  inset: 0;
  background: #fff;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-logo {
  width: 120px;
  animation: pulse 1.2s infinite;
}

@keyframes pulse {
  0%   { opacity: 1; }
  50%  { opacity: 0.4; }
  100% { opacity: 1; }
}
.header-flex {
  display: flex;
  align-items: center;
  gap: 12px; /* odstƒôp miƒôdzy logo a tytu≈Çem */
}
.logo {
  height: 40px; /* dopasuj wysoko≈õƒá loga */
  width: auto;
}

  .dropdown { position: relative; }
.dropdown .submenu {
  position: absolute; top: 100%; left: 0;
  background: #fff; border: 1px solid var(--border); border-radius: 10px;
  box-shadow: 0 8px 20px rgba(13,59,102,.12);
  padding: 6px; display: none; z-index: 10; min-width: 180px;
}
.dropdown.open .submenu { display: block; }
.sub-btn {
  display: block; width: 100%; text-align: left;
  border: 0; background: #fff; padding: 8px 10px; border-radius: 8px; cursor: pointer;
}
.sub-btn:hover { background: var(--row-alt); }

  /* TOP kwalifikacja w rankingu og√≥lnym */
tr.qualify td{
  background:#ecfdf5 !important;  /* jasnozielone t≈Ço */
  color:#065f46;                   /* ciemnozielony tekst */
  font-weight:600;
}
  /* DODAJ / UZUPE≈ÅNIJ */
.tabs { display:flex; flex-direction:column; gap:10px; }   /* dwie linie zak≈Çadek */
.tabs-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

.dropdown { position: relative; display:inline-block; }    /* NIE rozciƒÖga siƒô na ca≈ÇƒÖ szeroko≈õƒá */
.dropdown .submenu {
  position: absolute; top: 100%; left: 0;
  background: #fff; border: 1px solid var(--border); border-radius: 10px;
  box-shadow: 0 8px 20px rgba(13,59,102,.12);
  padding: 6px; display: none; z-index: 10; min-width: 180px;
}
.dropdown.open .submenu { display: block; }

</style>
</head>
<body>
<header>
  <div class="wrap header-flex">
    <img src="logo-pzps.png" alt="Logo PZPS" class="logo" />
    <h1>Rozgrywki m≈Çodzie≈ºowe ‚Äì terminarze i rankingi</h1>
  </div>
</header>

<main class="container">
  <div class="tabs">

  <!-- üîπ Wiersz 1: M≈ÅODZIK -->
  <div class="tabs-row">
    <button class="tab-btn active" data-view="m_roz1">M≈Çodzik ‚Äì Rozstaw I</button>
    <button class="tab-btn" data-view="m_roz2">M≈Çodzik ‚Äì Rozstaw II</button>

    <div class="dropdown">
      <button class="tab-btn dropdown-toggle" data-view="m_liga" aria-expanded="false">M≈Çodzik ‚Äì Liga ‚ñæ</button>
      <div class="submenu">
        <button class="sub-btn" data-view="m_liga" data-round="1">Turniej 1</button>
        <button class="sub-btn" data-view="m_liga" data-round="2">Turniej 2</button>
        <button class="sub-btn" data-view="m_liga" data-round="3">Turniej 3</button>
        <button class="sub-btn" data-view="m_liga" data-round="4">Turniej 4</button>
        <button class="sub-btn" data-view="m_liga" data-round="5">Turniej 5</button>
      </div>
    </div>

    <button class="tab-btn" data-view="m_overall">M≈Çodzik ‚Äì Ranking og√≥lny</button>
    <button class="tab-btn" data-view="m_final">M≈Çodzik ‚Äì Fina≈Ç</button>
  </div>

  <!-- üîπ Wiersz 2: M≈ÅODZICZKA -->
  <div class="tabs-row">
    <button class="tab-btn" data-view="f_roz1">M≈Çodziczka ‚Äì Rozstaw I</button>
    <button class="tab-btn" data-view="f_roz2">M≈Çodziczka ‚Äì Rozstaw II</button>

    <div class="dropdown">
      <button class="tab-btn dropdown-toggle" data-view="f_liga" aria-expanded="false">M≈Çodziczka ‚Äì Liga ‚ñæ</button>
      <div class="submenu">
        <button class="sub-btn" data-view="f_liga" data-round="1">Turniej 1</button>
        <button class="sub-btn" data-view="f_liga" data-round="2">Turniej 2</button>
        <button class="sub-btn" data-view="f_liga" data-round="3">Turniej 3</button>
        <button class="sub-btn" data-view="f_liga" data-round="4">Turniej 4</button>
        <button class="sub-btn" data-view="f_liga" data-round="5">Turniej 5</button>
      </div>
    </div>

    <button class="tab-btn" data-view="f_overall">M≈Çodziczka ‚Äì Ranking og√≥lny</button>
    <button class="tab-btn" data-view="f_final">M≈Çodziczka ‚Äì Fina≈Ç</button>
  </div>

</div>

</main>

   
    </div>
  </div>

  <!-- Ekran ≈Çadowania -->
  <div id="loading-screen">
    <img src="logo-pzps.png" alt="PZPS" class="loading-logo">
    <p>≈Åadowanie danych...</p>
  </div>

  <div id="view"></div>
</main>

<script>
// ========= KONFIG =========
// je≈õli masz CORS ok na Apps Script, mo≈ºesz u≈ºyƒá bezpo≈õrednio WEB_APP_URL_BASE + "?action=get"
const WEB_APP_URL_BASE = "https://script.google.com/macros/s/AKfycbzGJbfzKvY0Z9m1xC1CLuf7mBhFy3Glv1JuQhEoMo0ASXliQgwfUJJaLVcVzqDybCUa/exec";
const WEB_APP_URL = "https://corsproxy.io/?" + encodeURIComponent(WEB_APP_URL_BASE + "?action=get&cb=" + Date.now());

// ========= Utils =========
function isUrl(v){ try{ const u = new URL((v||'').trim()); return /^https?:$/.test(u.protocol); }catch(e){ return false; } }
function parseDateAny(v){
  if (v instanceof Date && !isNaN(v)) return v;
  if (typeof v === 'string' && v.includes('T')) { const d = new Date(v); if (!isNaN(d)) return d; }
  if (typeof v === 'string' && v.includes('.')){ const [d,m,y] = v.split('.').map(Number); const dd = new Date(y,(m||1)-1,d||1); if (!isNaN(dd)) return dd; }
  const d = new Date(v); return isNaN(d) ? null : d;
}
function fmtPL(v){ const d = parseDateAny(v); return d ? d.toLocaleDateString('pl-PL') : (v ?? ''); }

function makeTableEl(headers, rows){
  const wrap = document.createElement('div'); wrap.className='table-wrap';
  const table = document.createElement('table');
  const thead = document.createElement('thead'); const trh = document.createElement('tr');
  headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    r.forEach((cell, idx)=>{
      const td = document.createElement('td');
      if (cell && cell.__html){ td.innerHTML = cell.__html; } else { td.textContent = (cell ?? ''); }
      if (idx===0 && typeof cell === 'string') td.classList.add('left');
      if (idx===0 && cell && cell.__html){
        const span=td.querySelector('span[data-rowcls]'); const rowCls=span?span.getAttribute('data-rowcls'):'';
        if (rowCls) tr.classList.add(rowCls);
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); wrap.appendChild(table);
  return wrap;
}

// ========= Sety + punktacja 2/1 =========
// Funkcja liczƒÖca sety i punkty dla pojedynczego meczu
function parseSets(setsStr){
  const txt = (setsStr||'').toString().trim();
  if (!txt) return {hSets:0, aSets:0, hPts:0, aPts:0};

  const parts = txt.split(/[\s,]+/);
  let hSets=0, aSets=0, hPts=0, aPts=0;

  parts.forEach(p=>{
    const [h,a] = p.split(':').map(n=>parseInt(n,10));
    if(isNaN(h)||isNaN(a)) return;
    hPts += h;
    aPts += a;
    if(h > a) hSets++;
    else if(a > h) aSets++;
  });

  return {hSets, aSets, hPts, aPts};
}

// Funkcja generujƒÖca ranking z listy mecz√≥w
function generateRanking(matches){
  const teams = {};

  matches.forEach(match=>{
    const {Gospodarz, Go≈õƒá, Sety} = match;
    const {hSets, aSets, hPts, aPts} = parseSets(Sety);

    // Inicjalizacja dru≈ºyn
    if(!teams[Gospodarz]) teams[Gospodarz] = {M:0, W:0, P:0, setyH:0, setyA:0, pktH:0, pktA:0};
    if(!teams[Go≈õƒá]) teams[Go≈õƒá] = {M:0, W:0, P:0, setyH:0, setyA:0, pktH:0, pktA:0};

    // Mecze
    teams[Gospodarz].M++;
    teams[Go≈õƒá].M++;

    // Sety
    teams[Gospodarz].setyH += hSets;
    teams[Gospodarz].setyA += aSets;
    teams[Go≈õƒá].setyH += aSets;
    teams[Go≈õƒá].setyA += hSets;

    // Ma≈Çe punkty
    teams[Gospodarz].pktH += hPts;
    teams[Gospodarz].pktA += aPts;
    teams[Go≈õƒá].pktH += aPts;
    teams[Go≈õƒá].pktA += hPts;

    // Punkty za zwyciƒôstwo (liczone po setach z pojedynczego meczu)
    if(hSets > aSets){
      teams[Gospodarz].W++;
      teams[Go≈õƒá].P++;
    } else if(aSets > hSets){
      teams[Go≈õƒá].W++;
      teams[Gospodarz].P++;
    }
  });

  // Tworzymy ranking w formie tablicy
  const ranking = Object.keys(teams).map(team=>{
    const t = teams[team];
    const setyRatio = `${t.setyH}:${t.setyA}`;
    const pktRatio = (t.pktH/t.pktA).toFixed(3);
    const punkty = t.W*1; // punkty za zwyciƒôstwo
    return {
      Dru≈ºyna: team,
      M: t.M,
      W: t.W,
      P: t.P,
      'Sety (+/‚àí)': setyRatio,
      'Ma≈Çe punkty (ratio)': `${t.pktH}:${t.pktA} (ratio ${pktRatio})`,
      Punkty: punkty
    };
  });

  // Sortowanie: punkty, sety, ma≈Çe punkty
  ranking.sort((a,b)=>{
    if(b.Punkty !== a.Punkty) return b.Punkty - a.Punkty;

    const [bSetH,bSetA] = b['Sety (+/‚àí)'].split(':').map(Number);
    const [aSetH,aSetA] = a['Sety (+/‚àí)'].split(':').map(Number);
    const bSetRatio = bSetH/bSetA;
    const aSetRatio = aSetH/aSetA;
    if(bSetRatio !== aSetRatio) return bSetRatio - aSetRatio;

    const [bPtsH,bPtsA] = b['Ma≈Çe punkty (ratio)'].split(' ')[0].split(':').map(Number);
    const [aPtsH,aPtsA] = a['Ma≈Çe punkty (ratio)'].split(' ')[0].split(':').map(Number);
    return (bPtsH/bPtsA) - (aPtsH/aPtsA);
  });

  return ranking;
}


function matchPointsTwoOne(hSets,aSets){
  if (hSets + aSets === 0) return {home:0, away:0};
  if (hSets > aSets) return {home:2, away:1};
  if (aSets > hSets) return {home:1, away:2};
  return {home:0, away:0};
}

function computeTable(rows){
  const teams = {};
  
  // pomocnik: zwraca obiekt dru≈ºyny lub tworzy nowy
  const ensure = name => teams[name] || (teams[name] = {
    team: name, matches:0, wins:0, losses:0, setsFor:0, setsAgainst:0, smallFor:0, smallAgainst:0, points:0
  });

  rows.forEach(r=>{
    const homeName = (r[1]||'').toString().trim();
    const awayName = (r[2]||'').toString().trim();
    const setsStr = (r[4]||'').toString().trim();

    if(!homeName || !awayName || !setsStr) return;

    const {hSets, aSets, hPts, aPts} = parseSets(setsStr);
    if(hSets + aSets === 0) return; // mecz bez set√≥w ‚Äì ignoruj

    const home = ensure(homeName);
    const away = ensure(awayName);

    // mecze
    home.matches++; away.matches++;

    // sety i ma≈Çe punkty ‚Äì zawsze ‚Äûdla dru≈ºyny‚Äù
    home.setsFor += hSets;
    home.setsAgainst += aSets;
    home.smallFor += hPts;
    home.smallAgainst += aPts;

    away.setsFor += aSets;
    away.setsAgainst += hSets;
    away.smallFor += aPts;
    away.smallAgainst += hPts;

    // punkty meczowe 2/1
    const {home:hp, away:ap} = matchPointsTwoOne(hSets, aSets);
    home.points += hp;
    away.points += ap;

    // zwyciƒôstwa i pora≈ºki
    if(hSets > aSets){ home.wins++; away.losses++; }
    else if(aSets > hSets){ away.wins++; home.losses++; }
  });

  // konwertujemy na tablicƒô do sortowania
  const arr = Object.values(teams).map(t=>({
    ...t,
    setRatio: t.setsAgainst===0 ? (t.setsFor>0 ? Infinity : 0) : t.setsFor / t.setsAgainst,
    smallDiff: t.smallFor - t.smallAgainst
  }));

  // sortowanie: punkty, ratio sety, r√≥≈ºnica ma≈Çych punkt√≥w, alfabet
  arr.sort((a,b)=>{
    if(b.points !== a.points) return b.points - a.points;
    if(b.setRatio !== a.setRatio) return b.setRatio - a.setRatio;
    if(b.smallDiff !== a.smallDiff) return b.smallDiff - a.smallDiff;
    return a.team.localeCompare(b.team,'pl');
  });

  return arr;
}



// ========= Status/kolory wierszy =========
function hasScoreOrSets(score, sets){ const sOk = typeof score==='string' && score.includes(':'); const setsOk = typeof sets==='string' && /\d+:\d+/.test(sets); return sOk || setsOk; }
function isUpcomingDate(rawDate){ const d=parseDateAny(rawDate); if(!d) return false; const t=new Date(); t.setHours(0,0,0,0); return d>=t; }
function statusBadge(row){
  const [rawDate, , , score, sets] = row; const played=hasScoreOrSets(score,sets);
  if (played) return {text:'‚úÖ Rozegrany', cls:'chip-played', rowCls:'row-played'};
  if (isUpcomingDate(rawDate)) return {text:'‚è≥ NadchodzƒÖcy', cls:'chip-upcoming', rowCls:'row-upcoming'};
  return {text:'‚Äî', cls:'', rowCls:''};
}

// ========= Grupowania =========
function normRoman(g){
  if (!g) return '';
  const s=g.toString().trim().toUpperCase();
  if (/^\d+$/.test(s)){
    const n=parseInt(s,10);
    const romans=['','I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV','XV','XVI','XVII','XVIII','XIX','XX'];
    return romans[n]||s;
  }
  return s;
}
function normalizeSub(x){
  // normalizuj: spacje, wielko≈õƒá, kreski
  let s = (x || '').toString().trim().toUpperCase()
    .replace(/\s+/g, ' ')
    .replace(/[‚Äì‚Äî‚àí]/g, '-'); // en/em/minus -> zwyk≈Çy '-'

  // wywal prefixy typu "O MIEJSCA", "MIEJSCA"
  s = s.replace(/^O\s*MIEJSCA\s*/, '').replace(/^MIEJSCA\s*/, '');

  // prosty maping cyfr ‚Üí rzymskie i odwrotnie dla najczƒôstszych zakres√≥w
  const map = {
    '1-4': 'I-IV',
    '1‚Äì4': 'I-IV',
    'I-4': 'I-IV',
    'I-IV': 'I-IV',

    '5-7': 'V-VII',
    '5‚Äì7': 'V-VII',
    'V-7': 'V-VII',
    'V-VII': 'V-VII',
  };

  // klasyczne A/B zostawiamy
  if (s === 'A' || s === 'B') return s;

  return map[s] || s; // je≈õli nie znamy ‚Äì pokazuj jak jest po normalizacji kresek
}

function groupByRozstaw(rows){
  // -> { 'I': { 'A': [...], 'B': [...], 'I-IV': [...], 'V-VII': [...] }, ... }
  const out = {};
  rows.forEach(r=>{
    const g = normRoman(r[5] || '');      // kol. 6: Grupa (I/II/III‚Ä¶)
    const rawSub = r[6] || '';            // kol. 7: Podgrupa (A/B/O miejsca‚Ä¶)
    const sub = normalizeSub(rawSub);

    if (!g || !sub) return;
    (out[g] ||= {});
    (out[g][sub] ||= []).push(r);
  });
  return out;
}
  function groupByLiga(rows, ligaColIndex){
  const out = {};
  rows.forEach(r=>{
    const l = normRoman(r[ligaColIndex]||''); 
    if(!l) return;
    (out[l] ||= []).push(r);
  });
  return out;
}



// ========= Renderery terminarzy =========
function renderTermRozstaw(title, rows){
  const headers = ['Data','Gospodarz','Go≈õƒá','Wynik','Sety','Grupa','Podgrupa','Status','Protok√≥≈Ç'];
  const mapped = rows.slice()
    .sort((a,b)=> (parseDateAny(a[0])?.getTime()||0) - (parseDateAny(b[0])?.getTime()||0))
    .map(r=>{
      const st=statusBadge(r);
      const dateCell={__html:`<span data-rowcls="${st.rowCls||''}">${fmtPL(r[0])}</span>`};
      const proto = isUrl(r[7]) ? {__html:`<a href="${r[7]}" target="_blank" rel="noopener">üìÑ protok√≥≈Ç</a>`} : '‚Äî';
      const badge = st.cls ? {__html:`<span class="chip ${st.cls}">${st.text}</span>`} : st.text;
      return [dateCell, r[1], r[2], r[3]||'', r[4]||'', r[5]||'', r[6]||'', badge, proto];
    });
  return makeCard(title, makeTableEl(headers, mapped));
}
function renderTermLigaM(title, rows){
  const headers = ['Data','Gospodarz','Go≈õƒá','Wynik','Sety','Liga','Kolejka','Status','Protok√≥≈Ç'];
  const mapped = rows.slice()
    .sort((a,b)=> (parseDateAny(a[0])?.getTime()||0) - (parseDateAny(b[0])?.getTime()||0))
    .map(r=>{
      const st=statusBadge(r);
      const dateCell={__html:`<span data-rowcls="${st.rowCls||''}">${fmtPL(r[0])}</span>`};
      const proto = isUrl(r[7]) ? {__html:`<a href="${r[7]}" target="_blank" rel="noopener">üìÑ protok√≥≈Ç</a>`} : '‚Äî';
      const badge = st.cls ? {__html:`<span class="chip ${st.cls}">${st.text}</span>`} : st.text;
      return [dateCell, r[1], r[2], r[3]||'', r[4]||'', r[5]||'', r[6]||'', badge, proto];
    });
  return makeCard(title, makeTableEl(headers, mapped));
}
function renderTermLigaF(title, rows){
  const headers = ['Data','Gospodarz','Go≈õƒá','Wynik','Sety','Liga','Status','Protok√≥≈Ç'];
  const mapped = rows.slice()
    .sort((a,b)=> (parseDateAny(a[0])?.getTime()||0) - (parseDateAny(b[0])?.getTime()||0))
    .map(r=>{
      const st=statusBadge(r);
      const dateCell={__html:`<span data-rowcls="${st.rowCls||''}">${fmtPL(r[0])}</span>`};
      const proto = isUrl(r[6]) ? {__html:`<a href="${r[6]}" target="_blank" rel="noopener">üìÑ protok√≥≈Ç</a>`} : '‚Äî';
      const badge = st.cls ? {__html:`<span class="chip ${st.cls}">${st.text}</span>`} : st.text;
      return [dateCell, r[1], r[2], r[3]||'', r[4]||'', r[5]||'', badge, proto];
    });
  return makeCard(title, makeTableEl(headers, mapped));
}
function renderTermFinal(title, rows){
  const headers = ['Data','Gospodarz','Go≈õƒá','Wynik','Sety','Status','Protok√≥≈Ç'];
  const mapped = rows.slice()
    .sort((a,b)=> (parseDateAny(a[0])?.getTime()||0) - (parseDateAny(b[0])?.getTime()||0))
    .map(r=>{
      const st=statusBadge(r);
      const dateCell={__html:`<span data-rowcls="${st.rowCls||''}">${fmtPL(r[0])}</span>`};
      const proto = isUrl(r[5]) ? {__html:`<a href="${r[5]}" target="_blank" rel="noopener">üìÑ protok√≥≈Ç</a>`} : '‚Äî';
      const badge = st.cls ? {__html:`<span class="chip ${st.cls}">${st.text}</span>`} : st.text;
      return [dateCell, r[1], r[2], r[3]||'', r[4]||'', badge, proto];
    });
  return makeCard(title, makeTableEl(headers, mapped));
}

// ========= Bonusy fina≈Çowe =========
const BONUS_BY_KIND = { mlodzik:16, mlodziczka:42 };
function classificationBonus(place, maxBonus){ const v = maxBonus - (place - 1); return v>=1 ? v : 1; }

// ===== RANKING (z/bez bonus√≥w, z ratio ma≈Çych punkt√≥w) =====
// renderRanking(title, tableRows, opts?)
//   opts = { final: true/false, kind: 'mlodzik'|'mlodziczka', maxBonus?: number }
function renderRanking(title, tableRows, opts = {}) {
  const isFinal  = !!opts.final;
  const maxBonus = Number(
    opts.maxBonus ?? BONUS_BY_KIND[opts.kind] ?? 0
  );

  let headers, rows;
  if (!isFinal) {
    headers = [
      'Miejsce','Dru≈ºyna','M','W','P',
      'Sety (+/‚àí)','Ma≈Çe punkty (ratio)','Punkty'
    ];
    rows = tableRows.map((t, idx) => {
      const ratio = t.smallAgainst > 0
        ? (t.smallFor / t.smallAgainst).toFixed(3)
        : '‚àû';
      return [
        idx + 1,
        t.team,
        t.matches,
        t.wins,
        t.losses,
        `${t.setsFor}:${t.setsAgainst}`,
        `${t.smallFor}:${t.smallAgainst} (ratio ${ratio})`,
        t.points
      ];
    });
  } else {
    headers = [
      'Miejsce','Dru≈ºyna','M','W','P',
      'Sety (+/‚àí)','Ma≈Çe punkty (ratio)',
      'Punkty meczowe','Klasyfikacyjne','Razem'
    ];
    rows = tableRows.map((t, idx) => {
      const ratio = t.smallAgainst > 0
        ? (t.smallFor / t.smallAgainst).toFixed(3)
        : '‚àû';
      const place = idx + 1;
      const bonus = classificationBonus(place, maxBonus);
      const total = t.points + bonus;
      return [
        place,
        t.team,
        t.matches,
        t.wins,
        t.losses,
        `${t.setsFor}:${t.setsAgainst}`,
        `${t.smallFor}:${t.smallAgainst} (ratio ${ratio})`,
        t.points,
        bonus,
        total
      ];
    });
  }

  return makeCard(title, makeTableEl(headers, rows));
}

/* ======== CUSTOM RANKINGI ‚Äì M≈ÅODZICZKA ======== */

/** Sprawdza czy wiersz ma rozstrzygniƒôty wynik i zwraca {winner, loser} */
function winnerLoserFromRow(row){
  // row: [date, home, away, wynik, sety, ...]
  const home = (row[1]||'').toString().trim();
  const away = (row[2]||'').toString().trim();
  const setsStr = (row[4]||'').toString().trim();

  // parsujemy sety jak zwykle
  const {hSets, aSets} = parseSets(setsStr);
  if ((hSets + aSets) === 0) return null; // brak wyniku

  if (hSets > aSets) return { winner: home, loser: away };
  if (aSets > hSets) return { winner: away, loser: home };
  return null; // remis nie wystƒôpuje, ale na wszelki wypadek
}

/** Zwraca tylko wiersze danej podgrupy, posortowane chronologicznie i z wynikiem */
function playedRowsSorted(rows){
  const withScore = rows.filter(r => hasScoreOrSets(r[3], r[4]));
  return withScore.sort((a,b)=> (parseDateAny(a[0])?.getTime()||0) - (parseDateAny(b[0])?.getTime()||0));
}

/** Renderer ‚Äûtylko kolejno≈õƒá‚Äù dla 1‚Äì4 na podstawie dw√≥ch mecz√≥w decydujƒÖcych.
 *  Domy≈õlnie bierze 3-ci i 4-ty rozegrany mecz w podgrupie (indeksy 2 i 3).
 *  Je≈õli brakuje danych, robi ostro≈ºny fallback.
 */
function renderRankingCustomTop4(title, subgroupRows, decisiveIdxA = 2, decisiveIdxB = 3){
  const played = playedRowsSorted(subgroupRows);

  // domy≈õlnie: mecz nr 3 decyduje o 1‚Äì2, mecz nr 4 decyduje o 3‚Äì4
  const m12 = played[decisiveIdxA] ? winnerLoserFromRow(played[decisiveIdxA]) : null;
  const m34 = played[decisiveIdxB] ? winnerLoserFromRow(played[decisiveIdxB]) : null;

  let order = [];
  if (m12 && m34){
    order = [m12.winner, m12.loser, m34.winner, m34.loser];
  } else if (m12){
    // mamy tylko fina≈Ç: 1‚Äì2 z fina≈Çu, a o 3‚Äì4 fallback z computeTable
    const rest = computeTable(subgroupRows).map(x=>x.team).filter(t => t!==m12.winner && t!==m12.loser);
    order = [m12.winner, m12.loser, rest[0]||'', rest[1]||''];
  } else {
    // brak decydujƒÖcych mecz√≥w ‚Üí fallback: zwyk≈Ça tabela, ale poka≈º tylko 1‚Äì4
    order = computeTable(subgroupRows).slice(0,4).map(x=>x.team);
  }

  const headers = ['Miejsce','Dru≈ºyna'];
  const rows = order.map((team, idx)=> [idx+1, team||'‚Äî']);
  return makeCard(title, makeTableEl(headers, rows));
}

/** Renderer 5‚Äì7: normalne liczenie, ale podpisy miejsc jako 5/6/7 */
function renderRankingVtoVII(title, subgroupRows){
  // we≈∫ kolejno≈õƒá z computeTable, 3 dru≈ºyny
  const order = computeTable(subgroupRows).map(x=>x.team);
  const headers = ['Miejsce','Dru≈ºyna'];
  const rows = order.slice(0,3).map((team, idx)=> [5+idx, team||'‚Äî']); // 5,6,7
  return makeCard(title, makeTableEl(headers, rows));
}

/** Normalizuje etykietƒô podgrupy do jednego z: 'A','B','I-IV','V-VII', ‚Ä¶ */
function normalizeSubLabel(x){
  const s = (x||'').toString().trim().toUpperCase()
    .replace(/\s+/g,'')          // usu≈Ñ spacje
    .replace('OMIEJSCA','')      // ‚ÄûO MIEJSCA ‚Ä¶‚Äù
    .replace('O-MIEJSCA','')
    .replace('O_MIEJSCA','');

  if (s === 'A' || s === 'B') return s;
  if (s === 'I-IV' || s === 'I‚ÄìIV' || s === 'I-IV' || s === 'I-IV') return 'I-IV';
  if (s === 'V-VII' || s === 'V‚ÄìVII' || s === 'V-VII') return 'V-VII';

  // r√≥≈ºne warianty zapisu
  if (s === 'IIV' || s === '1-4' || s === '1‚Äì4') return 'I-IV';
  if (s === 'VVII' || s === '5-7' || s === '5‚Äì7') return 'V-VII';

  return s; // nieznane ‚Üí zostaw jak jest
}

function viewRozstaw(label, rows){
  const groups = groupByRozstaw(rows);
  const root = document.createElement('div');
  const order = ['', 'I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV'];

  Object.keys(groups)
    .sort((a,b)=> order.indexOf(a) - order.indexOf(b))
    .forEach(g => {
      Object.keys(groups[g]).forEach(sub => {
        const pack = groups[g][sub];
        if (!pack || pack.length === 0) return;

        const grid = document.createElement('div'); 
        grid.className = 'grid';

        // Terminarz
        const term = renderTermRozstaw(`${label} ‚Äì Rozstaw ${g} ‚Äì Podgrupa ${sub}`, pack);

        // Ranking z pe≈Çnymi statystykami
        const tableData = computeTable(pack);
        const subNorm = normalizeSubLabel(sub);
        const rank = renderRanking(`Ranking ‚Äì ${label} ‚Äì Rozstaw ${g} ‚Äì Podgrupa ${sub}`, tableData);

        // Pod≈õwietlenie najlepszych miejsc
        let topCount = 0;
        if(subNorm === 'I-IV') topCount = 4;
        else if(subNorm === 'V-VII') topCount = 3;

        if(topCount > 0){
          const trs = rank.querySelectorAll('tbody tr');
          trs.forEach((tr, idx)=>{ if(idx < topCount) tr.classList.add('qualify'); });
        }

        grid.appendChild(term);
        grid.appendChild(rank);
        root.appendChild(grid);
      });
    });

  if (!root.children.length) { 
    root.appendChild(makeCard(`${label} ‚Äì Rozstaw`, document.createTextNode('Brak danych'))); 
  }
  return root;
}

function normalizeSubLabel(sub) {
  return sub.replace(/\s+/g, '').toUpperCase();
}

function playedRowsSorted(pack) {
  return pack.filter(r => r[0] && r[1] && r[2]).sort((a, b) => a[0].localeCompare(b[0]));
}

function computeCustomTop4(pack, idxA, idxB) {
  const rows = playedRowsSorted(pack);
  const matchA = rows[idxA];
  const matchB = rows[idxB];
  if (!matchA || !matchB) return [];

  const res = [];
  // Mecz A decyduje o 1 i 2 miejscu
  res.push(['1 miejsce', matchA[1]]);
  res.push(['2 miejsce', matchA[2]]);
  // Mecz B decyduje o 3 i 4 miejscu
  res.push(['3 miejsce', matchB[1]]);
  res.push(['4 miejsce', matchB[2]]);
  return res;
}





function viewLigaM(rows){
  const byLiga = groupByLiga(rows, 5); // kolumna ‚ÄûLiga‚Äù
  const root = document.createElement('div');
  const order = ['', 'I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV'];

  Object.keys(byLiga).sort((a,b) => order.indexOf(a) - order.indexOf(b)).forEach(l => {
    const pack = byLiga[l];
    if (!pack || !pack.length) return;

    const grid = document.createElement('div');
    grid.className = 'grid';

    // Terminarz
    const term = renderTermLigaM(`M≈Çodzik ‚Äì Liga ${l}`, pack);

    // Ranking ‚Äì tylko rozegrane mecze
    const playedMatches = pack.filter(r => hasScoreOrSets(r[3], r[4]));
    const rank = renderRanking(`Ranking ‚Äì M≈Çodzik ‚Äì Liga ${l}`, computeTable(playedMatches));

    grid.appendChild(term);
    grid.appendChild(rank);
    root.appendChild(grid);
  });

  if (!root.children.length) {
    root.appendChild(makeCard(`M≈Çodzik ‚Äì Liga`, document.createTextNode('Brak danych')));
  }
  return root;
}

function viewLigaF(rows){
  const byLiga = groupByLiga(rows, 5); // kolumna ‚ÄûLiga‚Äù
  const root = document.createElement('div');
  const order = ['', 'I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV'];

  Object.keys(byLiga).sort((a,b) => order.indexOf(a) - order.indexOf(b)).forEach(l => {
    const pack = byLiga[l];
    if (!pack || !pack.length) return;

    const grid = document.createElement('div');
    grid.className = 'grid';

    // Terminarz
    const term = renderTermLigaF(`M≈Çodziczka ‚Äì Liga ${l}`, pack);

    // Ranking ‚Äì tylko rozegrane mecze
    const playedMatches = pack.filter(r => hasScoreOrSets(r[3], r[4]));
    const rank = renderRanking(`Ranking ‚Äì M≈Çodziczka ‚Äì Liga ${l}`, computeTable(playedMatches));

    grid.appendChild(term);
    grid.appendChild(rank);
    root.appendChild(grid);
  });

  if (!root.children.length) {
    root.appendChild(makeCard(`M≈Çodziczka ‚Äì Liga`, document.createTextNode('Brak danych')));
  }
  return root;
}
function renderFinalView(allRows, label){
  const view = document.createElement('div');
  const grid = document.createElement('div'); grid.className='grid';
  const term = renderTermFinal(`${label} ‚Äì Fina≈Ç`, allRows);
  const table = computeTable(allRows);
  const kind = (label==='M≈Çodzik') ? 'mlodzik' : (label==='M≈Çodziczka' ? 'mlodziczka' : undefined);
  const rank = kind ? renderRanking(`Ranking ‚Äì ${label} ‚Äì Fina≈Ç`, table, { final:true, kind }) : renderRanking(`Ranking ‚Äì ${label} ‚Äì Fina≈Ç`, table);
  grid.appendChild(term); grid.appendChild(rank); view.appendChild(grid);
  return view;
}
function viewOverallManual(label, rows){
  // rows = [Dru≈ºyna, T1, T2, T3, T4, T5]
  const normalized = rows.map(r=>{
    const team = (r[0] || '').toString().trim();
    const t = [1,2,3,4,5].map(i => {
      const v = Number(r[i]);
      return Number.isFinite(v) ? v : 0;
    });
    const total = t.reduce((a,b)=>a+b,0);
    return { team, t1:t[0], t2:t[1], t3:t[2], t4:t[3], t5:t[4], total };
  }).filter(x=>x.team);

  // sort: Razem malejƒÖco, potem nazwƒÖ
  normalized.sort((a,b)=>{
    if (b.total !== a.total) return b.total - a.total;
    return a.team.localeCompare(b.team,'pl');
  });

  const headers = ['Miejsce','Dru≈ºyna','Turniej 1','Turniej 2','Turniej 3','Turniej 4','Turniej 5','Razem'];
  const body = normalized.map((x,idx)=>[
    idx+1, x.team, x.t1, x.t2, x.t3, x.t4, x.t5, x.total
  ]);

  // zbuduj tabelƒô
  const tableEl = makeTableEl(headers, body);

  // ile wierszy ma byƒá na zielono
  const top = (label === 'M≈Çodziczka') ? 6 : (label === 'M≈Çodzik') ? 4 : 0;

  // dodaj klasƒô .qualify pierwszym 'top' wierszom
  const trs = tableEl.querySelectorAll('tbody tr');
  trs.forEach((tr, idx)=>{ if (idx < top) tr.classList.add('qualify'); });

  return makeCard(`Ranking og√≥lny ‚Äì ${label} `, tableEl);
}
  

// ========= Router zak≈Çadek =========
let DATA = null;

// --- wyb√≥r rund ligi (M/F) ---
let CURRENT_M_ROUND = 1; // startowo Turniej 1
let CURRENT_F_ROUND = 1;

// --- helpery do pobierania wierszy z LIGI ---
function getLigaRows(kind, round){
  // kind: 'm' | 'f', round: 1..5
  const keyArray  = `${kind}_liga`;           // np. m_liga (gdy jest obiekt/‚Äûtablica‚Äù z rundami)
  const keySingle = `${kind}_liga${round}`;   // np. m_liga1 ‚Ä¶ m_liga5 (gdy sƒÖ osobne pola)

  // wariant: { m_liga: {1:[...],2:[...],...} } lub { m_liga: [ , [...],[...], ... ] }
  if (DATA && DATA[keyArray] && (typeof DATA[keyArray] === 'object')) {
    return DATA[keyArray][round] || [];
  }
  // wariant: { m_liga1:[...], m_liga2:[...], ... }
  return (DATA && DATA[keySingle]) ? DATA[keySingle] : [];
}

function getLigaAllRows(kind){
  let out = [];
  for (let r = 1; r <= 5; r++) {
    const chunk = getLigaRows(kind, r);
    if (Array.isArray(chunk)) out = out.concat(chunk);
  }
  return out;
}

// pod≈õwietlanie aktywnej zak≈Çadki
function setActive(btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function renderView(kind){
  const mount = document.getElementById('view');
  mount.innerHTML = '';
  if (!DATA) return;

  if (kind==='m_roz1')          mount.appendChild( viewRozstaw('M≈Çodzik',     DATA.m_rozstaw_i  || [], ['I']) );
  else if (kind==='m_roz2')     mount.appendChild( viewRozstaw('M≈Çodzik',     DATA.m_rozstaw_ii || [], ['II']) );
  else if (kind==='m_final')    mount.appendChild( renderFinalView(           DATA.m_final      || [], 'M≈Çodzik') );
  else if (kind==='f_roz1')     mount.appendChild( viewRozstaw('M≈Çodziczka',  DATA.f_rozstaw_i  || [], ['I']) );
  else if (kind==='f_roz2')     mount.appendChild( viewRozstaw('M≈Çodziczka',  DATA.f_rozstaw_ii || [], ['II']) );
  else if (kind==='f_final')    mount.appendChild( renderFinalView(           DATA.f_final      || [], 'M≈Çodziczka') );
  else if (kind === 'm_liga')   mount.appendChild( viewLigaM( getLigaRows('m', CURRENT_M_ROUND) ) );
  else if (kind === 'f_liga')   mount.appendChild( viewLigaF( getLigaRows('f', CURRENT_F_ROUND) ) );
  else if (kind === 'm_overall')mount.appendChild( viewOverallManual('M≈Çodzik',     DATA.m_overall || []) );
  else if (kind === 'f_overall')mount.appendChild( viewOverallManual('M≈Çodziczka',  DATA.f_overall || []) );
}

// ========= Start =========
async function boot(){
  try{
    const res = await fetch(WEB_APP_URL, {cache:'no-store'});
    if (!res.ok) throw new Error('HTTP '+res.status);
    DATA = await res.json();
  }catch(err){
    const mount=document.getElementById('view');
    const card = makeCard('B≈ÇƒÖd', document.createTextNode('Nie uda≈Ço siƒô pobraƒá danych z Apps Script.\nSzczeg√≥≈Çy: '+err));
    mount.appendChild(card);
    return;
  }
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ setActive(btn); renderView(btn.dataset.view); });
  });
  renderView('m_roz1'); // domy≈õlnie

  // üîΩ schowaj ekran ≈Çadowania
  document.getElementById('loading-screen').style.display = 'none';
}
boot();

  // wybrane rundy (je≈õli jeszcze nie masz)

// toggle dropdown√≥w
function setupDropdowns(){
  // otwieranie/zamykanie
  document.querySelectorAll('.dropdown .dropdown-toggle').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const dd = btn.closest('.dropdown');
      const isOpen = dd.classList.toggle('open');
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    });
  });
  // zamykanie po klikniƒôciu poza
  document.addEventListener('click', ()=> {
    document.querySelectorAll('.dropdown.open').forEach(dd=>{
      dd.classList.remove('open');
      const toggle = dd.querySelector('.dropdown-toggle');
      if (toggle) toggle.setAttribute('aria-expanded','false');
    });
  });
  // klik w pozycje submenu
  document.querySelectorAll('.dropdown .submenu .sub-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const view = btn.dataset.view;         // 'm_liga' | 'f_liga'
      const round = parseInt(btn.dataset.round, 10) || 1;
      if (view === 'm_liga') CURRENT_M_ROUND = round;
      if (view === 'f_liga') CURRENT_F_ROUND = round;

      // pod≈õwietl g≈Ç√≥wny przycisk jako aktywny
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      const parentToggle = btn.closest('.dropdown').querySelector('.dropdown-toggle');
      if (parentToggle) parentToggle.classList.add('active');

      // render odpowiedniego widoku
      renderView(view);

      // zamknij submenu
      const dd = btn.closest('.dropdown');
      if (dd) dd.classList.remove('open');
      if (parentToggle) parentToggle.setAttribute('aria-expanded','false');
    });
  });
}

// wywo≈Çaj po zainicjowaniu zak≈Çadek i danych
// ‚Ä¶w Twoim boot():
// document.querySelectorAll('.tab-btn').forEach(...)
// renderView('m_rozstaw1')  // lub co tam masz
// ‚Üì dodaj:
setupDropdowns();


// ========= makeCard helper =========
function makeCard(title, innerEl){
  const card=document.createElement('div'); card.className='card';
  const head=document.createElement('div'); head.className='card-header'; head.innerHTML=`<h2>${title}</h2>`;
  const body=document.createElement('div'); body.className='card-body'; body.appendChild(innerEl);
  card.appendChild(head); card.appendChild(body); return card;
}
</script>
</body>
</html>
